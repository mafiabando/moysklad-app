<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–π –°–∫–ª–∞–¥ App - –í–µ–± –≤–µ—Ä—Å–∏—è</title>
    
    <!-- PWA –º–µ—Ç–∞-—Ç–µ–≥–∏ -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="–ú–æ–π–°–∫–ª–∞–¥">
    <meta name="description" content="–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API –ú–æ–π–°–∫–ª–∞–¥ - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏, –ø—Ä–æ–¥–∞–∂–∞–º–∏ –∏ –ø—Ä–∏—ë–º–∫–∞–º–∏">
    
    <!-- –ò–∫–æ–Ω–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ -->
    <link rel="icon" type="image/svg+xml" href="/icon.svg">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <meta name="msapplication-TileImage" content="/icon-192.png">
    <meta name="msapplication-TileColor" content="#667eea">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .menu-item {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-decoration: none;
            color: #333;
            transition: transform 0.2s, box-shadow 0.2s;
            border: none;
            cursor: pointer;
        }
        
        .menu-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .menu-item h3 {
            margin-bottom: 10px;
            color: #667eea;
        }
        
        .menu-item p {
            color: #666;
            font-size: 14px;
        }
        
        .section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .btn {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
            margin-right: 10px;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .hidden {
            display: none;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .cards-grid {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }
        
        .card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .search-box {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .row {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .col {
            flex: 1;
            position: relative;
        }
        
        .position-row {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
        }
        
        .purchase-price-hint {
            color: #666;
            font-size: 12px;
            display: block;
            margin-top: 2px;
        }
        
        .product-suggestions {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: calc(100% - 2px);
        }
        
        .suggestion-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .suggestion-item:hover {
            background: #f5f5f5;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üì¶ –ú–æ–π –°–∫–ª–∞–¥ App - –í–µ–± –≤–µ—Ä—Å–∏—è</h1>
            <p>–ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API –ú–æ–π–°–∫–ª–∞–¥</p>
        </header>

        <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
        <div id="mainMenu">
            <div class="menu">
                <button class="menu-item" onclick="showSection('products')">
                    <h3>üìã –¢–æ–≤–∞—Ä—ã</h3>
                    <p>–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏</p>
                </button>
                
                <button class="menu-item" onclick="showSection('sales')">
                    <h3>üí∞ –û—Ç–≥—Ä—É–∑–∫–∏</h3>
                    <p>–°–æ–∑–¥–∞–Ω–∏–µ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ–¥–∞–∂</p>
                </button>
                
                <button class="menu-item" onclick="showSection('purchases')">
                    <h3>üì¶ –ü—Ä–∏—ë–º–∫–∏</h3>
                    <p>–°–æ–∑–¥–∞–Ω–∏–µ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–∏—ë–º–æ–∫ —Ç–æ–≤–∞—Ä–∞</p>
                </button>
                
                <button class="menu-item" onclick="showSection('counterparties')">
                    <h3>üë• –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã</h3>
                    <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º–∏</p>
                </button>
                
                <button class="menu-item" onclick="showSection('settings')">
                    <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                    <p>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API</p>
                </button>
            </div>
        </div>

        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div id="settingsSection" class="hidden">
            <div class="section">
                <button class="btn btn-secondary" onclick="showSection('main')" style="margin-bottom: 20px;">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –º–µ–Ω—é</button>
                
                <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ API</h2>
                <form id="settingsForm">
                    <div class="form-group">
                        <label for="username">–õ–æ–≥–∏–Ω:</label>
                        <input type="text" id="username" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                        <input type="password" id="password" required>
                    </div>
                    
                    <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                    <button type="button" class="btn" onclick="testConnection()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
                </form>
                
                <div id="connectionStatus"></div>
            </div>
        </div>

        <!-- –¢–æ–≤–∞—Ä—ã -->
        <div id="productsSection" class="hidden">
            <div class="section">
                <button class="btn btn-secondary" onclick="showSection('main')" style="margin-bottom: 20px;">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –º–µ–Ω—é</button>
                
                <div class="row">
                    <div class="col">
                        <h2>üìã –¢–æ–≤–∞—Ä—ã</h2>
                    </div>
                    <div class="col" style="flex: none;">
                        <button class="btn" onclick="loadProducts()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                    </div>
                </div>
                
                <input type="text" class="search-box" id="productSearch" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤..." onkeyup="filterProducts()">
                
                <div id="productsContent" class="loading">
                    –ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
                </div>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã -->
        <div id="counterpartiesSection" class="hidden">
            <div class="section">
                <button class="btn btn-secondary" onclick="showSection('main')" style="margin-bottom: 20px;">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –º–µ–Ω—é</button>
                
                <div class="row">
                    <div class="col">
                        <h2>üë• –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã</h2>
                    </div>
                    <div class="col" style="flex: none;">
                        <button class="btn" onclick="loadCounterparties()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                    </div>
                </div>
                
                <input type="text" class="search-box" id="counterpartySearch" placeholder="–ü–æ–∏—Å–∫ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤..." onkeyup="filterCounterparties()">
                
                <div id="counterpartiesContent" class="loading">
                    –ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤
                </div>
            </div>
        </div>

        <!-- –û—Ç–≥—Ä—É–∑–∫–∏ -->
        <div id="salesSection" class="hidden">
            <div class="section">
                <button class="btn btn-secondary" onclick="showSection('main')" style="margin-bottom: 20px;">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –º–µ–Ω—é</button>
                
                <h2>üí∞ –û—Ç–≥—Ä—É–∑–∫–∏ (–ü—Ä–æ–¥–∞–∂–∏)</h2>
                <p>–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –æ—Ç–≥—Ä—É–∑–∫–∏:</p>
                
                <form id="saleForm">
                    <div class="form-group">
                        <label for="saleOrganization">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è:</label>
                        <select id="saleOrganization" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="saleStore">–°–∫–ª–∞–¥:</label>
                        <select id="saleStore" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="saleCounterparty">–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç:</label>
                        <select id="saleCounterparty" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞</option>
                        </select>
                    </div>
                    
                    <h3>–¢–æ–≤–∞—Ä—ã:</h3>
                    <div id="salePositions">
                        <div class="position-row">
                            <div class="row">
                                <div class="col">
                                    <label>–¢–æ–≤–∞—Ä:</label>
                                    <input type="text" class="position-product-search" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..." required>
                                    <input type="hidden" class="position-product" required>
                                    <div class="product-suggestions" style="display: none;"></div>
                                </div>
                                <div class="col">
                                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                                    <input type="number" class="position-quantity" min="1" value="1" required>
                                </div>
                                <div class="col">
                                    <label>–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ (—Ä—É–±):</label>
                                    <input type="number" class="position-price" min="0" step="0.01" required>
                                    <small class="purchase-price-hint"></small>
                                </div>
                                <div class="col" style="flex: none;">
                                    <label>&nbsp;</label>
                                    <button type="button" class="btn btn-secondary" onclick="removePosition(this)">‚ùå</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-secondary" onclick="addPosition()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label>
                            <input type="checkbox" id="notifyTelegram" onchange="toggleTelegramComment()"> 
                            üì¢ –û–ø–æ–≤–µ—Å—Ç–∏—Ç—å –≤ Telegram
                        </label>
                    </div>
                    
                    <div class="form-group" id="telegramCommentGroup" style="display: none;">
                        <label for="telegramComment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –æ—Ç–≥—Ä—É–∑–∫–µ:</label>
                        <textarea id="telegramComment" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–≥—Ä—É–∑–∫–µ..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
                    </div>
                    
                    <button type="submit" class="btn">üí∞ –°–æ–∑–¥–∞—Ç—å –æ—Ç–≥—Ä—É–∑–∫—É</button>
                </form>
                
                <div id="saleStatus"></div>
            </div>
        </div>

        <!-- –ü—Ä–∏—ë–º–∫–∏ -->
        <div id="purchasesSection" class="hidden">
            <div class="section">
                <button class="btn btn-secondary" onclick="showSection('main')" style="margin-bottom: 20px;">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –º–µ–Ω—é</button>
                
                <h2>üì¶ –ü—Ä–∏—ë–º–∫–∏ —Ç–æ–≤–∞—Ä–∞</h2>
                <p>–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø—Ä–∏—ë–º–∫–∏:</p>
                
                <form id="purchaseForm">
                    <div class="form-group">
                        <label for="purchaseOrganization">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è:</label>
                        <select id="purchaseOrganization" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="purchaseStore">–°–∫–ª–∞–¥:</label>
                        <select id="purchaseStore" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="purchaseCounterparty">–ü–æ—Å—Ç–∞–≤—â–∏–∫:</label>
                        <select id="purchaseCounterparty" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</option>
                        </select>
                    </div>
                    
                    <h3>–¢–æ–≤–∞—Ä—ã:</h3>
                    <div id="purchasePositions">
                        <div class="position-row">
                            <div class="row">
                                <div class="col">
                                    <label>–¢–æ–≤–∞—Ä:</label>
                                    <input type="text" class="position-product-search" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..." required>
                                    <input type="hidden" class="position-product" required>
                                    <div class="product-suggestions" style="display: none;"></div>
                                </div>
                                <div class="col">
                                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                                    <input type="number" class="position-quantity" min="1" value="1" required>
                                </div>
                                <div class="col">
                                    <label>–¶–µ–Ω–∞ –∑–∞–∫—É–ø–∫–∏ (—Ä—É–±):</label>
                                    <input type="number" class="position-price" min="0" step="0.01" required>
                                    <small class="sale-price-hint"></small>
                                </div>
                                <div class="col" style="flex: none;">
                                    <label>&nbsp;</label>
                                    <button type="button" class="btn btn-secondary" onclick="removePurchasePosition(this)">‚ùå</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-secondary" onclick="addPurchasePosition()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
                    <button type="submit" class="btn">üì¶ –°–æ–∑–¥–∞—Ç—å –ø—Ä–∏—ë–º–∫—É</button>
                </form>
                
                <div id="purchaseStatus"></div>
            </div>
        </div>
    </div>

    <script>
        let currentProducts = [];
        let currentCounterparties = [];
        let currentOrganizations = [];
        let currentStores = [];
        let settings = {};

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —Å–µ–∫—Ü–∏—è–º–∏
        function showSection(section) {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('settingsSection').classList.add('hidden');
            document.getElementById('productsSection').classList.add('hidden');
            document.getElementById('salesSection').classList.add('hidden');
            document.getElementById('purchasesSection').classList.add('hidden');
            document.getElementById('counterpartiesSection').classList.add('hidden');
            
            if (section === 'main') {
                document.getElementById('mainMenu').classList.remove('hidden');
            } else {
                document.getElementById(section + 'Section').classList.remove('hidden');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Å–µ–∫—Ü–∏–∏
                if (section === 'sales' || section === 'purchases') {
                    loadSelectData();
                }
            }
        }

        // API —Ñ—É–Ω–∫—Ü–∏–∏
        async function apiRequest(endpoint, options = {}) {
            if (!settings.username || !settings.password) {
                throw new Error('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ API –Ω–µ –∑–∞–¥–∞–Ω—ã. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–ù–∞—Å—Ç—Ä–æ–π–∫–∏"');
            }

            const credentials = btoa(settings.username + ':' + settings.password);
            
            const response = await fetch('/api' + endpoint, {
                headers: {
                    'Authorization': 'Basic ' + credentials,
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${await response.text()}`);
            }

            return response.json();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
        async function loadAllItems(endpoint, includeStock = false) {
            let allItems = [];
            let offset = 0;
            const limit = 1000; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç API
            
            while (true) {
                try {
                    let url = `${endpoint}?limit=${limit}&offset=${offset}`;
                    
                    const data = await apiRequest(url);
                    const items = data.rows || [];
                    
                    if (items.length === 0) {
                        break; // –ë–æ–ª—å—à–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
                    }
                    
                    allItems = allItems.concat(items);
                    offset += limit;
                    
                    // –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ –º–µ–Ω—å—à–µ –ª–∏–º–∏—Ç–∞, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
                    if (items.length < limit) {
                        break;
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                } catch (error) {
                    console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å offset ${offset}:`, error);
                    break;
                }
            }
            
            console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allItems.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–∑ ${endpoint}`);
            return allItems;
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        document.getElementById('settingsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            settings = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value
            };
            
            localStorage.setItem('moySkladSettings', JSON.stringify(settings));
            
            const status = document.getElementById('connectionStatus');
            status.innerHTML = '<div class="status success">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!</div>';
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        async function testConnection() {
            const status = document.getElementById('connectionStatus');
            status.innerHTML = '<div class="status">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...</div>';
            
            try {
                const tempSettings = {
                    username: document.getElementById('username').value,
                    password: document.getElementById('password').value
                };
                
                if (!tempSettings.username || !tempSettings.password) {
                    throw new Error('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å');
                }

                const credentials = btoa(tempSettings.username + ':' + tempSettings.password);
                const response = await fetch('/api/entity/organization', {
                    headers: {
                        'Authorization': 'Basic ' + credentials,
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const orgName = data.rows && data.rows[0] ? data.rows[0].name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                    status.innerHTML = `<div class="status success">‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!<br>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è: ${orgName}</div>`;
                } else {
                    const errorText = await response.text();
                    status.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞: ${response.status}<br>${errorText}</div>`;
                }
            } catch (error) {
                status.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
        async function loadProducts() {
            const content = document.getElementById('productsContent');
            content.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤...</div>';
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã
                currentProducts = await loadAllItems('/entity/product', false);
                
                if (currentProducts.length === 0) {
                    content.innerHTML = '<p>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                    return;
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –æ—Å—Ç–∞—Ç–∫–∏ –æ—Ç–¥–µ–ª—å–Ω–æ, –≤–∫–ª—é—á–∞—è –Ω—É–ª–µ–≤—ã–µ
                content.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤ (–≤–∫–ª—é—á–∞—è –Ω—É–ª–µ–≤—ã–µ)...</div>';
                
                // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –í–°–ï –æ—Å—Ç–∞—Ç–∫–∏ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
                const stockData = await loadAllItems('/report/stock/all?includeZeroStocks=true', false);
                
                console.log('–î–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ (–≤—Å–µ):', stockData.slice(0, 3)); // –û—Ç–ª–∞–¥–∫–∞
                
                // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–æ href —Ç–æ–≤–∞—Ä–æ–≤
                const stockMap = {};
                stockData.forEach(item => {
                    let productHref = item.meta?.href;
                    if (productHref) {
                        // –û—á–∏—â–∞–µ–º href –æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ expand, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                        productHref = productHref.split('?')[0];
                        
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–µ stock –∏–∑ –æ–±—ä–µ–∫—Ç–∞ item
                        const stockQuantity = item.stock || item.quantity || 0;
                        stockMap[productHref] = stockQuantity;
                    }
                });
                
                console.log('–ö–∞—Ä—Ç–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤:', Object.keys(stockMap).length, '—Ç–æ–≤–∞—Ä–æ–≤'); // –û—Ç–ª–∞–¥–∫–∞
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–∫–∏ –∫ —Ç–æ–≤–∞—Ä–∞–º
                currentProducts.forEach(product => {
                    // –û—á–∏—â–∞–µ–º href —Ç–æ–≤–∞—Ä–∞ –æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
                    const cleanProductHref = product.meta.href.split('?')[0];
                    product.currentStock = stockMap[cleanProductHref] || 0;
                });
                
                console.log('–ü–µ—Ä–≤—ã–µ 3 —Ç–æ–≤–∞—Ä–∞ —Å API:', currentProducts.slice(0, 3).map(p => ({
                    name: p.name,
                    href: p.meta.href.split('?')[0],
                    currentStock: p.currentStock
                })));
                
                displayProducts(currentProducts);
            } catch (error) {
                content.innerHTML = `<div class="status error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }

        function displayProducts(products) {
            const content = document.getElementById('productsContent');
            
            // –õ–æ–≥–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            if (products.length > 0) {
                console.log('–ü–µ—Ä–≤—ã–µ 3 —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:', products.slice(0, 3).map(p => ({
                    name: p.name,
                    href: p.meta.href,
                    currentStock: p.currentStock,
                    stock: p.stock,
                    quantity: p.quantity,
                    reserve: p.reserve
                })));
            }
            
            content.innerHTML = `
                <div class="cards-grid">
                    ${products.map(product => {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º currentStock –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å
                        let stock = product.currentStock || 0;
                        
                        const stockColor = stock > 0 ? '#28a745' : '#dc3545';
                        const stockText = stock > 0 ? `${stock} —à—Ç` : '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏';
                        
                        return `
                        <div class="card">
                            <h4>${product.name}</h4>
                            <p><strong>–ö–æ–¥:</strong> ${product.code || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                            <p><strong>–ê—Ä—Ç–∏–∫—É–ª:</strong> ${product.article || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                            <p><strong>–ï–¥–∏–Ω–∏—Ü–∞:</strong> ${product.uom ? product.uom.name : '—à—Ç'}</p>
                            <p><strong>–û—Å—Ç–∞—Ç–æ–∫:</strong> <span style="color: ${stockColor}; font-weight: bold;">${stockText}</span></p>
                            <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${product.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                            <p><small><strong>Debug:</strong> currentStock=${product.currentStock}</small></p>
                        </div>
                    `}).join('')}
                </div>
            `;
        }

        function filterProducts() {
            const search = document.getElementById('productSearch').value.toLowerCase();
            const filtered = currentProducts.filter(product => 
                product.name.toLowerCase().includes(search) ||
                (product.code && product.code.toLowerCase().includes(search)) ||
                (product.article && product.article.toLowerCase().includes(search))
            );
            displayProducts(filtered);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤
        async function loadCounterparties() {
            const content = document.getElementById('counterpartiesContent');
            content.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤...</div>';
            
            try {
                currentCounterparties = await loadAllItems('/entity/counterparty');
                
                if (currentCounterparties.length === 0) {
                    content.innerHTML = '<p>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                    return;
                }
                
                displayCounterparties(currentCounterparties);
            } catch (error) {
                content.innerHTML = `<div class="status error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }

        function displayCounterparties(counterparties) {
            const content = document.getElementById('counterpartiesContent');
            content.innerHTML = `
                <div class="cards-grid">
                    ${counterparties.map(cp => `
                        <div class="card">
                            <h4>${cp.name}</h4>
                            <p><strong>–¢–∏–ø:</strong> ${cp.companyType === 'legal' ? '–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ' : cp.companyType === 'individual' ? '–§–∏–∑–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ' : '–ò–ü'}</p>
                            <p><strong>Email:</strong> ${cp.email || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                            <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${cp.phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                            <p><strong>–ò–ù–ù:</strong> ${cp.inn || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function filterCounterparties() {
            const search = document.getElementById('counterpartySearch').value.toLowerCase();
            const filtered = currentCounterparties.filter(cp => 
                cp.name.toLowerCase().includes(search) ||
                (cp.inn && cp.inn.includes(search)) ||
                (cp.email && cp.email.toLowerCase().includes(search))
            );
            displayCounterparties(filtered);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ–≤
        async function loadSelectData() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –í–°–ï —Ç–æ–≤–∞—Ä—ã –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ–≤
                if (currentProducts.length === 0) {
                    currentProducts = await loadAllItems('/entity/product', false);
                    
                    // –ü–æ–ª—É—á–∞–µ–º –æ—Å—Ç–∞—Ç–∫–∏ –æ—Ç–¥–µ–ª—å–Ω–æ, –≤–∫–ª—é—á–∞—è –Ω—É–ª–µ–≤—ã–µ
                    try {
                        const stockData = await loadAllItems('/report/stock/all?includeZeroStocks=true', false);
                        
                        console.log('–î–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ–≤:', stockData.slice(0, 3)); // –û—Ç–ª–∞–¥–∫–∞
                        
                        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–æ href —Ç–æ–≤–∞—Ä–æ–≤
                        const stockMap = {};
                        stockData.forEach(item => {
                            let productHref = item.meta?.href;
                            if (productHref) {
                                // –û—á–∏—â–∞–µ–º href –æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ expand, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                                productHref = productHref.split('?')[0];
                                
                                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–µ stock –∏–∑ –æ–±—ä–µ–∫—Ç–∞ item
                                const stockQuantity = item.stock || item.quantity || 0;
                                stockMap[productHref] = stockQuantity;
                            }
                        });
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–∫–∏ –∫ —Ç–æ–≤–∞—Ä–∞–º
                        currentProducts.forEach(product => {
                            // –û—á–∏—â–∞–µ–º href —Ç–æ–≤–∞—Ä–∞ –æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
                            const cleanProductHref = product.meta.href.split('?')[0];
                            product.currentStock = stockMap[cleanProductHref] || 0;
                        });
                        
                        console.log('–¢–æ–≤–∞—Ä—ã –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ–≤ —Å –æ—Å—Ç–∞—Ç–∫–∞–º–∏:', currentProducts.slice(0, 3).map(p => ({
                            name: p.name,
                            currentStock: p.currentStock
                        })));
                        
                    } catch (stockError) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Å—Ç–∞—Ç–∫–æ–≤:', stockError);
                        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º 0
                        currentProducts.forEach(product => {
                            product.currentStock = 0;
                        });
                    }
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ–≤
                if (currentCounterparties.length === 0) {
                    const counterpartiesData = await apiRequest('/entity/counterparty?limit=1000');
                    currentCounterparties = counterpartiesData.rows || [];
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
                if (currentOrganizations.length === 0) {
                    const organizationsData = await apiRequest('/entity/organization?limit=1000');
                    currentOrganizations = organizationsData.rows || [];
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∫–ª–∞–¥—ã
                if (currentStores.length === 0) {
                    const storesData = await apiRequest('/entity/store?limit=1000');
                    currentStores = storesData.rows || [];
                }
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç—ã
                fillSelects();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ–≤:', error);
            }
        }

        function fillSelects() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π –æ—Ç–≥—Ä—É–∑–æ–∫
            document.querySelectorAll('#salePositions .position-product-search').forEach(input => {
                setupProductSearch(input, 'sale');
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π –ø—Ä–∏—ë–º–æ–∫
            document.querySelectorAll('#purchasePositions .position-product-search').forEach(input => {
                setupProductSearch(input, 'purchase');
            });

            // –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã —Å –≤—ã–±–æ—Ä–æ–º "–†–∞–∑–æ–≤—ã–π" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const counterpartySelects = ['saleCounterparty', 'purchaseCounterparty'];
            counterpartySelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const razovyOption = currentCounterparties.find(cp => cp.name === '–†–∞–∑–æ–≤—ã–π');
                    let options = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞</option>' +
                        currentCounterparties.map(cp => 
                            `<option value="${cp.meta.href}">${cp.name}</option>`
                        ).join('');
                    
                    select.innerHTML = options;
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º "–†–∞–∑–æ–≤—ã–π" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω
                    if (razovyOption) {
                        select.value = razovyOption.meta.href;
                    }
                }
            });
            
            // –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —Å –≤—ã–±–æ—Ä–æ–º "–°—Ç—Ä–æ–π-–¥–æ–º" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const orgSelects = ['saleOrganization', 'purchaseOrganization'];
            orgSelects.forEach(selectId => {
                const orgSelect = document.getElementById(selectId);
                if (orgSelect) {
                    const stroydomOption = currentOrganizations.find(org => org.name === '–°—Ç—Ä–æ–π-–¥–æ–º');
                    let orgOptions = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</option>' +
                        currentOrganizations.map(org => 
                            `<option value="${org.meta.href}">${org.name}</option>`
                        ).join('');
                    
                    orgSelect.innerHTML = orgOptions;
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º "–°—Ç—Ä–æ–π-–¥–æ–º" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω
                    if (stroydomOption) {
                        orgSelect.value = stroydomOption.meta.href;
                    }
                }
            });
            
            // –°–∫–ª–∞–¥—ã —Å –≤—ã–±–æ—Ä–æ–º "–û—Å–Ω–æ–≤–Ω–æ–π —Å–∫–ª–∞–¥" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const storeSelects = ['saleStore', 'purchaseStore'];
            storeSelects.forEach(selectId => {
                const storeSelect = document.getElementById(selectId);
                if (storeSelect) {
                    const mainStoreOption = currentStores.find(store => store.name === '–û—Å–Ω–æ–≤–Ω–æ–π —Å–∫–ª–∞–¥');
                    let storeOptions = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥</option>' +
                        currentStores.map(store => 
                            `<option value="${store.meta.href}">${store.name}</option>`
                        ).join('');
                    
                    storeSelect.innerHTML = storeOptions;
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º "–û—Å–Ω–æ–≤–Ω–æ–π —Å–∫–ª–∞–¥" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω
                    if (mainStoreOption) {
                        storeSelect.value = mainStoreOption.meta.href;
                    }
                }
            });
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
        function setupProductSearch(input, formType = 'sale') {
            const hiddenInput = input.parentElement.querySelector('.position-product');
            const suggestionsDiv = input.parentElement.querySelector('.product-suggestions');
            
            input.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                
                if (query.length < 2) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }
                
                const filtered = currentProducts.filter(product =>
                    product.name.toLowerCase().includes(query) ||
                    (product.code && product.code.toLowerCase().includes(query)) ||
                    (product.article && product.article.toLowerCase().includes(query))
                );
                
                if (filtered.length > 0) {
                    suggestionsDiv.innerHTML = filtered.slice(0, 10).map(product => {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º currentStock –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å
                        let stock = product.currentStock || 0;
                        
                        const stockColor = stock > 0 ? '#28a745' : '#dc3545';
                        const stockText = stock > 0 ? `${stock} —à—Ç` : '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏';
                        
                        return `<div class="suggestion-item" data-href="${product.meta.href}" data-sale-price="${product.salePrices ? product.salePrices[0]?.value || 0 : 0}" data-buy-price="${product.buyPrice?.value || 0}" data-stock="${stock}">
                            <strong>${product.name}</strong><br>
                            <small>–ö–æ–¥: ${product.code || '–ù–µ—Ç'} | –ê—Ä—Ç–∏–∫—É–ª: ${product.article || '–ù–µ—Ç'}</small><br>
                            <small style="color: ${stockColor}; font-weight: bold;">–û—Å—Ç–∞—Ç–æ–∫: ${stockText}</small>
                        </div>`;
                    }).join('');
                    suggestionsDiv.style.display = 'block';
                } else {
                    suggestionsDiv.style.display = 'none';
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—é
            input.parentElement.addEventListener('click', function(e) {
                if (e.target.closest('.suggestion-item')) {
                    const item = e.target.closest('.suggestion-item');
                    const href = item.getAttribute('data-href');
                    const salePrice = item.getAttribute('data-sale-price') || 0;
                    const buyPrice = item.getAttribute('data-buy-price') || 0;
                    const stock = parseInt(item.getAttribute('data-stock')) || 0;
                    const name = item.querySelector('strong').textContent;
                    
                    input.value = name;
                    hiddenInput.value = href;
                    suggestionsDiv.style.display = 'none';
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—ã
                    const positionRow = input.closest('.position-row');
                    const priceInput = positionRow.querySelector('.position-price');
                    const priceHint = positionRow.querySelector('.purchase-price-hint, .sale-price-hint');
                    
                    if (formType === 'sale') {
                        priceInput.value = (salePrice / 100).toFixed(2);
                        if (priceHint) {
                            priceHint.textContent = `–¶–µ–Ω–∞ –∑–∞–∫—É–ø–∫–∏: ${(buyPrice / 100).toFixed(2)} —Ä—É–±.`;
                        }
                    } else {
                        priceInput.value = (buyPrice / 100).toFixed(2);
                        if (priceHint) {
                            priceHint.textContent = `–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏: ${(salePrice / 100).toFixed(2)} —Ä—É–±.`;
                        }
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å—Ç–∞—Ç–æ–∫ —Ä—è–¥–æ–º —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º —Ç–æ–≤–∞—Ä–∞
                    let stockDisplay = positionRow.querySelector('.stock-display');
                    if (!stockDisplay) {
                        stockDisplay = document.createElement('small');
                        stockDisplay.className = 'stock-display';
                        stockDisplay.style.marginLeft = '10px';
                        input.parentNode.appendChild(stockDisplay);
                    }
                    
                    const stockColor = stock > 0 ? '#28a745' : '#dc3545';
                    const stockText = stock > 0 ? `${stock} —à—Ç` : '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏';
                    stockDisplay.innerHTML = `<span style="color: ${stockColor}; font-weight: bold;">–û—Å—Ç–∞—Ç–æ–∫: ${stockText}</span>`;
                    
                    console.log('–í—ã–±—Ä–∞–Ω —Ç–æ–≤–∞—Ä:', name, '–æ—Å—Ç–∞—Ç–æ–∫:', stock); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
                }
            });
            
            // –°–∫—Ä—ã—Ç–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
            document.addEventListener('click', function(e) {
                if (!input.parentElement.contains(e.target)) {
                    suggestionsDiv.style.display = 'none';
                }
            });
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –¥–ª—è Telegram
        function toggleTelegramComment() {
            const checkbox = document.getElementById('notifyTelegram');
            const commentGroup = document.getElementById('telegramCommentGroup');
            
            if (checkbox.checked) {
                commentGroup.style.display = 'block';
            } else {
                commentGroup.style.display = 'none';
                document.getElementById('telegramComment').value = '';
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
        async function sendTelegramNotification(saleData, positions, comment) {
            try {
                let message = 'üöö –ù–æ–≤–∞—è –æ—Ç–≥—Ä—É–∑–∫–∞ —Å–æ–∑–¥–∞–Ω–∞\n\n';
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã
                let totalAmount = 0;
                positions.forEach((position, index) => {
                    const product = currentProducts.find(p => p.meta.href === position.assortment.meta.href);
                    const productName = product ? product.name : '–¢–æ–≤–∞—Ä';
                    const price = position.price / 100;
                    const amount = position.quantity * price;
                    totalAmount += amount;
                    
                    message += `${index + 1}. ${productName}\n`;
                    message += `   –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${position.quantity} —à—Ç\n`;
                    message += `   –¶–µ–Ω–∞: ${price.toFixed(2)} —Ä—É–±\n`;
                    message += `   –°—É–º–º–∞: ${amount.toFixed(2)} —Ä—É–±\n\n`;
                });
                
                message += `üí∞ –û–±—â–∞—è —Å—É–º–º–∞: ${totalAmount.toFixed(2)} —Ä—É–±`;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –µ—Å–ª–∏ –µ—Å—Ç—å
                if (comment && comment.trim()) {
                    message += `\n\nüí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:\n${comment.trim()}`;
                }
                
                // –ó–∞–º–µ–Ω—è–µ–º \n –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –¥–ª—è Telegram
                message = message.replace(/\\n/g, '\n');
                
                const response = await fetch('/api/telegram/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message })
                });
                
                if (!response.ok) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram:', error);
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏ —Ç–æ–≤–∞—Ä–∞ –≤ –æ—Ç–≥—Ä—É–∑–∫—É
        function addPosition() {
            const positionsContainer = document.getElementById('salePositions');
            const newPosition = document.createElement('div');
            newPosition.className = 'position-row';
            newPosition.innerHTML = `
                <div class="row">
                    <div class="col">
                        <label>–¢–æ–≤–∞—Ä:</label>
                        <input type="text" class="position-product-search" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..." required>
                        <input type="hidden" class="position-product" required>
                        <div class="product-suggestions" style="display: none;"></div>
                    </div>
                    <div class="col">
                        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                        <input type="number" class="position-quantity" min="1" value="1" required>
                    </div>
                    <div class="col">
                        <label>–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ (—Ä—É–±):</label>
                        <input type="number" class="position-price" min="0" step="0.01" required>
                        <small class="purchase-price-hint"></small>
                    </div>
                    <div class="col" style="flex: none;">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-secondary" onclick="removePosition(this)">‚ùå</button>
                    </div>
                </div>
            `;
            
            positionsContainer.appendChild(newPosition);
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏
            const productSearchInput = newPosition.querySelector('.position-product-search');
            setupProductSearch(productSearchInput, 'sale');
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —Ç–æ–≤–∞—Ä–∞ –∏–∑ –æ—Ç–≥—Ä—É–∑–∫–∏
        function removePosition(button) {
            const positionsContainer = document.getElementById('salePositions');
            if (positionsContainer.children.length > 1) {
                button.closest('.position-row').remove();
            } else {
                alert('–î–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –ø–æ–∑–∏—Ü–∏—è —Ç–æ–≤–∞—Ä–∞');
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏ —Ç–æ–≤–∞—Ä–∞ –≤ –ø—Ä–∏—ë–º–∫—É
        function addPurchasePosition() {
            const positionsContainer = document.getElementById('purchasePositions');
            const newPosition = document.createElement('div');
            newPosition.className = 'position-row';
            newPosition.innerHTML = `
                <div class="row">
                    <div class="col">
                        <label>–¢–æ–≤–∞—Ä:</label>
                        <input type="text" class="position-product-search" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..." required>
                        <input type="hidden" class="position-product" required>
                        <div class="product-suggestions" style="display: none;"></div>
                    </div>
                    <div class="col">
                        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                        <input type="number" class="position-quantity" min="1" value="1" required>
                    </div>
                    <div class="col">
                        <label>–¶–µ–Ω–∞ –∑–∞–∫—É–ø–∫–∏ (—Ä—É–±):</label>
                        <input type="number" class="position-price" min="0" step="0.01" required>
                        <small class="sale-price-hint"></small>
                    </div>
                    <div class="col" style="flex: none;">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-secondary" onclick="removePurchasePosition(this)">‚ùå</button>
                    </div>
                </div>
            `;
            
            positionsContainer.appendChild(newPosition);
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏
            const productSearchInput = newPosition.querySelector('.position-product-search');
            setupProductSearch(productSearchInput, 'purchase');
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —Ç–æ–≤–∞—Ä–∞ –∏–∑ –ø—Ä–∏—ë–º–∫–∏
        function removePurchasePosition(button) {
            const positionsContainer = document.getElementById('purchasePositions');
            if (positionsContainer.children.length > 1) {
                button.closest('.position-row').remove();
            } else {
                alert('–î–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –ø–æ–∑–∏—Ü–∏—è —Ç–æ–≤–∞—Ä–∞');
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–≥—Ä—É–∑–∫–∏
        document.getElementById('saleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const status = document.getElementById('saleStatus');
            status.innerHTML = '<div class="status">–°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–≥—Ä—É–∑–∫–∏...</div>';
            
            try {
                // –°–æ–±–∏—Ä–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ —Ñ–æ—Ä–º—ã
                const positions = [];
                const positionRows = document.querySelectorAll('#salePositions .position-row');
                
                for (const row of positionRows) {
                    const product = row.querySelector('.position-product').value;
                    const quantity = parseInt(row.querySelector('.position-quantity').value);
                    const price = Math.round(parseFloat(row.querySelector('.position-price').value) * 100); // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –∫–æ–ø–µ–π–∫–∏
                    
                    if (!product || !quantity || isNaN(price)) {
                        throw new Error('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –¥–ª—è –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤');
                    }
                    
                    positions.push({
                        assortment: {
                            meta: {
                                href: product,
                                type: "product",
                                mediaType: "application/json"
                            }
                        },
                        quantity: quantity,
                        price: price
                    });
                }
                
                const saleData = {
                    organization: {
                        meta: {
                            href: document.getElementById('saleOrganization').value,
                            type: "organization",
                            mediaType: "application/json"
                        }
                    },
                    store: {
                        meta: {
                            href: document.getElementById('saleStore').value,
                            type: "store",
                            mediaType: "application/json"
                        }
                    },
                    agent: {
                        meta: {
                            href: document.getElementById('saleCounterparty').value,
                            type: "counterparty",
                            mediaType: "application/json"
                        }
                    },
                    positions: positions
                };
                
                const result = await apiRequest('/entity/demand', {
                    method: 'POST',
                    body: JSON.stringify(saleData)
                });
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ
                const notifyTelegram = document.getElementById('notifyTelegram').checked;
                if (notifyTelegram) {
                    const comment = document.getElementById('telegramComment').value;
                    await sendTelegramNotification(saleData, positions, comment);
                }
                
                status.innerHTML = `<div class="status success">‚úÖ –û—Ç–≥—Ä—É–∑–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!<br>–ù–æ–º–µ—Ä: ${result.name || '–±/–Ω'}${notifyTelegram ? '<br>üì¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram' : ''}</div>`;
                document.getElementById('saleForm').reset();
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –¥–æ –æ–¥–Ω–æ–π
                const positionsContainer = document.getElementById('salePositions');
                const firstPosition = positionsContainer.querySelector('.position-row');
                positionsContainer.innerHTML = '';
                positionsContainer.appendChild(firstPosition);
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –ø–µ—Ä–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏
                firstPosition.querySelector('.position-product-search').value = '';
                firstPosition.querySelector('.position-product').value = '';
                firstPosition.querySelector('.position-quantity').value = '1';
                firstPosition.querySelector('.position-price').value = '';
                const priceHint = firstPosition.querySelector('.purchase-price-hint');
                if (priceHint) priceHint.textContent = '';
                const stockDisplay = firstPosition.querySelector('.stock-display');
                if (stockDisplay) stockDisplay.remove();
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                document.getElementById('notifyTelegram').checked = false;
                document.getElementById('telegramCommentGroup').style.display = 'none';
                document.getElementById('telegramComment').value = '';
                
                fillSelects();
                
            } catch (error) {
                status.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        });

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏—ë–º–∫–∏
        document.getElementById('purchaseForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const status = document.getElementById('purchaseStatus');
            status.innerHTML = '<div class="status">–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏—ë–º–∫–∏...</div>';
            
            try {
                // –°–æ–±–∏—Ä–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ —Ñ–æ—Ä–º—ã
                const positions = [];
                const positionRows = document.querySelectorAll('#purchasePositions .position-row');
                
                for (const row of positionRows) {
                    const product = row.querySelector('.position-product').value;
                    const quantity = parseInt(row.querySelector('.position-quantity').value);
                    const price = Math.round(parseFloat(row.querySelector('.position-price').value) * 100); // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –∫–æ–ø–µ–π–∫–∏
                    
                    if (!product || !quantity || isNaN(price)) {
                        throw new Error('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –¥–ª—è –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤');
                    }
                    
                    positions.push({
                        assortment: {
                            meta: {
                                href: product,
                                type: "product",
                                mediaType: "application/json"
                            }
                        },
                        quantity: quantity,
                        price: price
                    });
                }
                
                const purchaseData = {
                    organization: {
                        meta: {
                            href: document.getElementById('purchaseOrganization').value,
                            type: "organization",
                            mediaType: "application/json"
                        }
                    },
                    store: {
                        meta: {
                            href: document.getElementById('purchaseStore').value,
                            type: "store",
                            mediaType: "application/json"
                        }
                    },
                    agent: {
                        meta: {
                            href: document.getElementById('purchaseCounterparty').value,
                            type: "counterparty",
                            mediaType: "application/json"
                        }
                    },
                    positions: positions
                };
                
                const result = await apiRequest('/entity/supply', {
                    method: 'POST',
                    body: JSON.stringify(purchaseData)
                });
                
                status.innerHTML = `<div class="status success">‚úÖ –ü—Ä–∏—ë–º–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!<br>–ù–æ–º–µ—Ä: ${result.name || '–±/–Ω'}</div>`;
                document.getElementById('purchaseForm').reset();
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –¥–æ –æ–¥–Ω–æ–π
                const positionsContainer = document.getElementById('purchasePositions');
                const firstPosition = positionsContainer.querySelector('.position-row');
                positionsContainer.innerHTML = '';
                positionsContainer.appendChild(firstPosition);
                fillSelects();
                
            } catch (error) {
                status.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏—ë–º–∫–∏: ${error.message}</div>`;
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        window.onload = function() {
            const saved = localStorage.getItem('moySkladSettings');
            if (saved) {
                settings = JSON.parse(saved);
                document.getElementById('username').value = settings.username || '';
                document.getElementById('password').value = settings.password || '';
            }
        };
    </script>
</body>
</html>